# 2. 类型与值（Types and Values）

Lua 是一门动态类型语言，它没有类型定义，每一个值都自带类型。

Lua 中有八个基本类型：`nil`、`boolean`、`number`、`string`、`userdata`、`function`、`thread` 和 `table`。借助 `type` 函数，可以得到任何值对应的类型名称：

    print(type(nil))            --> nil
    print(type(true))           --> boolean
    print(type(10.4 * 3))       --> number
    print(type("Hello world"))  --> string
    print(type(print))          --> function
    print(type({}))             --> table
    print(type(type))           --> string

在 Lua 中，一个变量可以包含任何类型的值。虽然滥用会造成代码混乱，但在保持一个类型的同时，适当混用 `nil` 也是推荐的。


## 1. Nil

`nil` 是一个特殊的类型，它只有一个值，**nil**，主要用于与其他值做区分。Lua 使用 nil 表示空值，或者没有被赋值。

例如，一个全局变量在没有被赋值前，默认值就是 nil；你也可以给一个全局变量赋值为 nil，以删除该变量。


## 2. 布尔值（Booleans）

`boolean` 类型有两个值，**false** 和 **true**，用于表示传统的布尔值。

但在 Lua 的条件测试（conditional tests）中，任何值都可以作为控制结构（control structures）中的条件，它们的真假特性如下：

类型     | 条件假    | 条件真
-------- | --------- | ------------------------------
nil      | nil       |
布尔值   | **false** | **true**
数字     |           | 所有数字（包括 `0`）
字符串   |           | 所有字符串（包括空字符串 `""`）
其他类型 |           | 所有其他类型的值


## 3. 数字（Numbers）

`number` 类型表示所有实数（双精度浮点数）。在 Lua 中，没有整型。

有人担心用双精度浮点数表示整数会导致误差。实际上，按照 IEEE 754 标准，任何值小于 2 的 53 次方（约等于 10 的 16 次方）的整数，用双精度浮点数来表示都不会有误差。特别地，Lua 中的一个数字可以无误差地表示所有 32 位整数。

Lua 中的数字常量，除了整数部分，也可以包括小数部分和十进制指数部分。例如：

    4    0.4    4.57e-3    0.3e12    5E+20

数字常量还可以表示成十六进制的形式（以 `0x` 为前缀）；从 Lua 5.2 开始，十六进制常量还可以包括小数部分和二进制指数部分。例如：

    0xff (255)    0x1A3 (419)    0x0.2 (0.125)    0x1p-1 (0.5)    0xa.bp2 (42.75)

其中，括号里面是对应的十进制表示。


## 4. 字符串（Strings）

`string` 类型表示字符串，即一个字符序列。

Lua 中的字符串是不可变的（immutable）。你不能修改一个已有字符串，但可以创建一个包含指定修改的新字符串。例如：

    a = "one string"                      -- 已有字符串：one string
    b = string.gsub(a, "one", "another")  -- 包含指定修改的新字符串：another string

与其他 Lua 对象（如：表、函数等）一样，字符串的内存分配和释放工作，都 Lua 语言自动管理的。

理论上，字符串的长度是不受限制的。实际使用中，可以少到零个字符、单个字符，也可以多到 100K 或 1M 的字符。借助长度运算符（length operator）`#`，可以得到一个字符串的长度：

    a = "hello"
    print(#a)            --> 5
    print(#"good\0bye")  --> 8

### 字符串常量

字符串常量可以使用双引号 `"` 或者单引号 `'`。例如：

    "a string"    'another string'    "I'm ok"    'double quote ("")'

Lua 字符串也可以包括 C 语言风格的转义字符：

    \a  响铃字符
    \b  退格符
    \f  换页符
    \n  换行符
    \r  回车符
    \t  水平制表符
    \v  垂直制表符
    \\  反斜杠
    \"  双引号
    \'  单引号

### 长字符串

对于长字符串，特别是跨行字符串，可以用双方括号来定义。（对于 Lua 中的长注释，也可以采用这种方式。）

1. 简单的长字符串

        page = [[                      -- 第一个字符如果是换行符，则会被忽略掉
        <html>
        <head>
          <title>An HTML Page</title>  -- 转义字符也不会被转义
        </head>
        <body>
          <a href="http://www.lua.org">Lua</a>
        </body>
        </html>
        ]]

2. 如果长字符串中包含有 `]]` 字符，则在双方括号中添加（一个或多个）等号，以示区分

        complex = [=[
          This is a long string, followed with a long comment.
          -- [[
            This is a long comment.
          ]]    -- 匹配 [[
        ]=]    -- 匹配 [=[

### 自动类型强制转换

根据运算过程的需要，Lua 支持字符串和数字之间的自动转换。

如果运算过程期望一个数字的地方，出现了一个字符串，Lua 会自动将字符串转换为数字，再进行运算。例如：

    print("10" + 1)    --> 11
    print("-5.3e-10" * "2")    --> -1.06e-9
    print("hello" + 1)    --> ERROR (attempt to perform arithmetic on a string value)

如果运算过程中期望一个字符串的地方，出现了一个数字，Lua 会自动将数字转换为字符串，再进行运算。例如：

    print(10 .. 20)  --> 1020

**注意**: 实际编码中，不推荐依赖于这种自动转换机制，而是应该在需要作类型转换的地方明确进行转换。

#### 明确类型转换

1. 将字符串转换为数字（借助 `tonumber` 函数）

        n = tonumber("10")
        print(n, type(n))      --> 10   number

        n = tonumber("hello")
        print(n, type(n))      --> nil  nil

2. 将数字转换为字符串

    - 借助 `tostring` 函数

        print(tostring(10) == "10")  --> true

    - 连接数字和空字符串

        print(10 .. "" == "10")  --> true


## 5. 表（Tables）

`table` 类型实现了关联数组（associative arrays）。关联数组是指这样一种数组，它不仅可以按数字来索引，还可以按字符串，或者其他任何非 `nil` 的值来索引。

表是 Lua 中唯一的数据构造机制，它非常强大。借助于表，Lua 以一种简单、一致、高效的方式，实现了很多数据结构，包括数组（arrays）、集合（sets）、记录（records），以及包（packages）和对象（objects）。

例如，在其他语言中，我们通常将 `io.read` 理解为：`io` 模块中的 `read` 函数。而在 Lua 中，从技术上来讲，这个表达式则意味着：以字符串 `read` 为键，去索引表 `io`。

### 创建表

在 Lua 中，可以用构造表达式 {} 来创建一个表：

    a = {}         -- 创建一个表，并用变量 a 来指向它
    a["x"] = 10    -- 添加一个条目（键为字符串 "x"，值为数字 10）
    a[20] = "wow"  -- 添加一个条目（键为数字 20，值为字符串 "wow"）

与全局变量类似，一个表中：未初始化的字段，默认值为 nil；你也可以给一个字段赋值为 nil，以删除该字段。

### 记录

为了用表来表示记录，对于字符串类型的键，Lua 还提供了一个语法糖 `a.name` 用来表示 `a["name"]`。

    print(a.x == a["x"])  --> true   -- a.x 等价于 a["x"]

在 Lua 中，表的“点记法”（`a.name`）与“字符串记法”（`a["name"]`），在技术上是等价的。但在概念上，点记法更符合人们使用记录的习惯，一条记录的字段往往是固定的、预先定义好的；而字符串记法则隐含有动态特性，我们可以随时新增或删除表中的条目。

### 数组

以整数为键来使用表，就可以实现数组或列表。与 C 语言不同，Lua 语言的惯例是：数组索引从 1 开始计。

    a = {}
    a[1] = "x"  -- 数组索引从 1 开始计
    a[2] = "y"
    a[3] = "z"

数组（表）中可能会包含值为 nil 的元素，这些元素又叫做 `空洞`（holes）。如果一个列表没有空洞，我们称它为一个 `序列`。对于序列，Lua 提供了长度运算符 `#`，它返回数组中的最后一个索引，也就是序列的长度。例如：

    -- 打印数组 a 中的所有元素
    for i = 1, #a do
      print(a[i])
    end


## 6. 函数（Functions）

在 Lua 中，函数是第一等公民：函数可以被赋值给变量，可以作为参数传递给其他函数，也可以作为其他函数的返回值。同时，Lua 还提供函数式编程范式，支持基于词法作用域的闭包。

Lua 既可以调用 Lua 实现的函数，也可以调用 C 实现的函数。


## 7. 用户数据与线程（Userdata and Threads）

`userdata` 类型允许任意 C 数据被存储到 Lua 变量中。用户数据用于表示一个新类型，该类型由 C 程序或 C 库创建。

`thread` 类型与 Lua 中的协程（coroutines）有关。


## 练习题（Exercises）

### Q1. 表达式 `type(nil) == nil` 的值是多少（你可以借助 Lua 代码来验证你的答案）？你能解释产生这个结果的原因吗？

`type(nil) == nil` 的值为 `false`。

因为 `type` 函数返回的是类型名称，所以 `type(nil)` 返回字符串 `"nil"`，而 `nil` 是 nil 类型的值，所以二者不相等。

### Q2. 下列那些是合法的数字？它们的值分别是多少？

.0e12       -- 合法（值为 0）
.e12        -- 不合法
0.0e        -- 不合法
0x12        -- 合法（18）
0xABFG      -- 不合法
0xA         -- 合法（10）
FFFF        -- 不合法
0xFFFFFFFF  -- 合法（值为 4294967295）
0x          -- 不合法
0x1P10      -- 合法（值为 1024）
0.1e1       -- 合法（值为 1）
0x0.1p1     -- 合法（值为 0.125）

### Q3. 数字 12.7 等于分数 127/10，其中分母是 10 的幂。你能把它表达为以 2 的幂为分母的分数吗？再试试 5.5 呢？

以 2 的幂为分母的分数，12.7 可以表达为 0x19.6666666666666p-1，5.5 可以表达为 11/2。

### Q4. 如何将下列 XML 片段作为一个字符串嵌入到 Lua 中？（请至少给出两种方式。）

    <![CDATA[
      Hello world
    ]]>

第一种方式：

    xml = '<![CDATA[\n  Hello world\n]]>'

第二种方式：

    xml = [=[
    <![CDATA[
      Hello world
    ]]>
    ]=]

### Q5. 假设你需要将一个包含任意字节的序列格式化为 Lua 字符串常量，你该如何实现？实现的同时请考虑可读性、每行最大长度和性能。

暂略

### Q6. 假设有下列代码：

    a = {};  a.a = a

1. 请问 `a.a.a.a` 的值是多少？其中的任何一个 `a` 跟其他的 `a` 之间分别有什么不同？

    `a.a.a.a` 的值等于 `a.a.a` 的值等于 `a.a` 的值等于 `a` 的值，因为它们都指向同一个表。

2. 在上述代码的基础上，加上下面这行代码：`a.a.a.a = 3`，现在 `a.a.a.a` 的值又是多少？

    表达式 `a.a.a.a` 会报错，因为 `a.a.a.a = 3` 会使得 `a.a` 的值变成 `3`，所以 `a.a.a.a` 等效于 `3.a.a`，它不是合法的 Lua 表达式，因此会导致报错。
